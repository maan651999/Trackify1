@model List<Trackify.Application.DTOs.ExpenseDto>

@{
    ViewBag.Title = "Admin Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var budget = ViewBag.Budget as decimal? ?? 0;
    var total = ViewBag.Total as decimal? ?? 0;
    var remaining = budget - total;
}

<div class="dashboard-container">
    <h1 class="budget-title">
        📊 Premium Budget Report • @ViewBag.Date.ToString("dd") @ViewBag.Date.ToString("MMM") @ViewBag.Date.ToString("yyyy")
    </h1>

    <!-- Top Stats -->
    <!-- Font Awesome link (CDN add karna hoga) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <div class="stats-grid">
        <div class="stat-card">
            <h3><i class="fa-solid fa-sack-dollar icon"></i> Budget</h3>
            <p>₹@budget</p>
        </div>
        <div class="stat-card">
            <h3><i class="fa-solid fa-money-bill-trend-up icon"></i> Spent</h3>
            <p>₹@total</p>
        </div>
        <div class="stat-card">
            <h3><i class="fa-solid fa-wallet icon"></i> Remaining</h3>
            <p>₹@remaining</p>
        </div>
    </div>



    <!-- Chart & Latest Expenses -->
    <div class="dashboard-content">
        <div class="chart-card">
            <h2>Budget Chart Overview</h2>
            <canvas id="budgetChart"></canvas>
        </div>

        <div class="latest-requests">
            <h2>Latest Expenses</h2>
            <div class="table-responsive" style="max-height: 556px; overflow-y: auto;">
                <table class="table table-hover mb-0 budget-table">
                    <thead class="sticky-top">
                    <tr>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var expense in Model.OrderByDescending(e => e.Date).Take(10))
                    {
                        <tr>
                                <td>
                                    @{
                                        string category = expense.CategoryName;
                                        if (!string.IsNullOrEmpty(category) && category.StartsWith("*"))
                                        {
                                            <span style="color: red; font-weight: 900;">*</span>
                                            @category.Substring(1).TrimStart()
                                            // baaki ka naam normal dikhe
                                        }
                                        else
                                        {
                                            @category
                                        }
                                    }
                                </td>
                            <td>₹@expense.Amount</td>
                            <td>@expense.Date.ToString("dd MMM yyyy")</td>
                        </tr>
                    }
                </tbody>
            </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const budget = @budget;
    const spent = @total;
    const remaining = budget - spent;

    const ctx = document.getElementById('budgetChart').getContext('2d');

    const chartData = remaining <= 0
        ? {
            labels: ['Spent'],
            datasets: [{
                data: [spent],
                backgroundColor: ['#ff0000'],
                hoverOffset: 4
            }]
        }
        : {
            labels: ['Spent', 'Remaining'],
            datasets: [{
                data: [spent, remaining],
                backgroundColor: ['#C9CCDE', '#74BF44'],
                hoverOffset: 4
            }]
        };

    new Chart(ctx, {
        type: 'doughnut',
        data: chartData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Budget Utilization'
                }
            }
        }
    });

    if (remaining <= 0) {
        const alertBox = document.getElementById('budget-alert');
        alertBox.style.display = 'block';
    }

</script>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        @if (TempData["LoginSuccess"] != null)
        {
                        <text>
                        Swal.fire({
                            icon: 'success',
                            title: 'Welcome!',
                            text: '@TempData["LoginSuccess"]',
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });
                        </text>
        }
    </script>
}

<link rel="stylesheet" href="~/css/dashboard.css" />
